package com.location;

import static org.mockito.Mockito.times;
import static org.mockito.Mockito.verify;
import static org.mockito.Mockito.when;

import org.junit.jupiter.api.Assertions;
import org.junit.jupiter.api.Test;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.boot.test.mock.mockito.MockBean;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.client.RestClientException;
import org.springframework.web.client.RestTemplate;

import com.location.controller.ISSLocationController;
import com.location.response.ISSLocation;

@SpringBootTest
public class IssLocationControllerTest {
	@MockBean
    private RestTemplate restTemplate;

    @Test
    public void testGetIssLocationWhenApiIsUp() {
        // Arrange
        String apiUrl = "https://api.wheretheiss.at/v1/satellites/25544";
        String expectedResponse = "{\"latitude\": 50.1234, \"longitude\": 10.5678}";
        ResponseEntity<String> mockResponse = new ResponseEntity<>(expectedResponse, HttpStatus.OK);
        when(restTemplate.getForEntity(apiUrl, String.class)).thenReturn(mockResponse);

        // Act
        ISSLocationController controller = new ISSLocationController();
        ResponseEntity<ISSLocation> response = controller.getCurrentLocation();

        // Assert
        Assertions.assertEquals(HttpStatus.OK, response.getStatusCode());
        Assertions.assertEquals(50.1234, response.getBody().getLatitude());
        Assertions.assertEquals(10.5678, response.getBody().getLongitude());
        verify(restTemplate, times(1)).getForEntity(apiUrl, String.class);
    }

    @Test
    public void testGetIssLocationWhenApiIsDownAndRetrySucceeds() {
        // Arrange
        String apiUrl = "https://api.wheretheiss.at/v1/satellites/25544";
        String expectedResponse = "{\"latitude\": 51.2345, \"longitude\": 11.6789}";
        ResponseEntity<String> mockResponse = new ResponseEntity<>(expectedResponse, HttpStatus.OK);
        when(restTemplate.getForEntity(apiUrl, String.class))
                .thenThrow(new RestClientException("API is down"))
                .thenReturn(mockResponse);

        // Act
        ISSLocationController controller = new ISSLocationController();
        ResponseEntity<ISSLocation> response = controller.getCurrentLocation();

        // Assert
        Assertions.assertEquals(HttpStatus.OK, response.getStatusCode());
        Assertions.assertEquals(51.2345, response.getBody().getLatitude());
        Assertions.assertEquals(11.6789, response.getBody().getLongitude());
        verify(restTemplate, times(2)).getForEntity(apiUrl, String.class);
    }

    @Test
    public void testGetIssLocationWhenApiIsDownAndRetryFails() {
        // Arrange
        String apiUrl = "https://api.wheretheiss.at/v1/satellites/25544";
        when(restTemplate.getForEntity(apiUrl, String.class)).thenThrow(new RestClientException("API is down"));

        // Act
        IssLocationController controller = new IssLocationController(restTemplate);
        ResponseEntity<Location> response = controller.getIssLocation();

        // Assert
        Assertions.assertEquals(HttpStatus.INTERNAL_SERVER_ERROR, response.getStatusCode());
        Assertions.assertEquals(0.0, response.getBody().getLatitude());
        Assertions.assertEquals(0.0, response.getBody().getLongitude());
        verify(restTemplate, times(2)).getForEntity(apiUrl, String.class);
    }
}
